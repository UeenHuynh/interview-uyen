%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4C78A8', 'secondaryColor': '#F58518', 'tertiaryColor': '#E45756'}}}%%

flowchart TB
    subgraph RAW["üìÅ Raw Data"]
        EM["EM.csv<br/>256 features"]
        FLEN["FLEN.csv<br/>301 features"]
        NUC["NUCLEOSOME.csv<br/>601 features"]
    end

    subgraph STAGE0["Stage 0: Data Preparation"]
        S0_1["Transpose<br/>(features ‚Üí columns)"]
        S0_2["Add Prefixes<br/>(EM_, FLEN_, NUC_)"]
        S0_3["Label Encoding<br/>(6 classes)"]
        S0_4[("cleaned_data.parquet<br/>300 √ó 1,158")]
    end

    subgraph STAGE1["Stage 1: Quality Control"]
        S1_1["Train/Test Split<br/>80/20 Stratified"]
        S1_2["Zero-Variance Filter<br/>(-9 features)"]
        S1_3["Correlation Filter<br/>threshold=0.90<br/>(-608 features)"]
        S1_4["StandardScaler<br/>(fit on TRAIN only)"]
        S1_OUT[("X_train_scaled<br/>240 √ó 541")]
    end

    subgraph STAGE2["Stage 2: Feature Selection"]
        S2_A["Layer A: PLS-DA<br/>VIP Scoring<br/>‚Üí 120 features"]
        S2_B["Layer B: Stability Selection<br/>LASSO Bootstrap (100x)<br/>‚Üí 38 features"]
        S2_C["Layer C: Group PCA<br/>EM: 4 PCs<br/>FLEN: 5 PCs<br/>NUC: 5 PCs"]
        S2_OUT[("X_train_final<br/>240 √ó 14")]
    end

    subgraph STAGE3["Stage 3: Model Training"]
        S3_1["Nested CV<br/>10-outer / 5-inner"]
        S3_2["Models:<br/>LogReg, RF, SVM, XGBoost"]
        S3_3["Permutation Test<br/>1000 iterations"]
        S3_OUT[("Best Model")]
    end

    subgraph STAGE4["Stage 4: Evaluation"]
        S4_1["Strategy 1:<br/>Two-Stage<br/>(Binary ‚Üí 5-class)"]
        S4_2["Strategy 2:<br/>Direct 6-Class"]
        S4_3["Confusion Matrix<br/>Per-class F1"]
        S4_OUT["üìä Final Report"]
    end

    %% Connections
    EM --> S0_1
    FLEN --> S0_1
    NUC --> S0_1
    S0_1 --> S0_2
    S0_2 --> S0_3
    S0_3 --> S0_4

    S0_4 --> S1_1
    S1_1 --> S1_2
    S1_2 --> S1_3
    S1_3 --> S1_4
    S1_4 --> S1_OUT

    S1_OUT --> S2_A
    S2_A --> S2_B
    S2_B --> S2_C
    S2_C --> S2_OUT

    S2_OUT --> S3_1
    S3_1 --> S3_2
    S3_2 --> S3_3
    S3_3 --> S3_OUT

    S3_OUT --> S4_1
    S3_OUT --> S4_2
    S4_1 --> S4_3
    S4_2 --> S4_3
    S4_3 --> S4_OUT

    %% Styling
    classDef raw fill:#E8F4EA,stroke:#2E7D32
    classDef stage0 fill:#E3F2FD,stroke:#1565C0
    classDef stage1 fill:#FFF3E0,stroke:#EF6C00
    classDef stage2 fill:#F3E5F5,stroke:#7B1FA2
    classDef stage3 fill:#FFEBEE,stroke:#C62828
    classDef stage4 fill:#E0F7FA,stroke:#00838F
    classDef data fill:#FFF9C4,stroke:#F9A825

    class EM,FLEN,NUC raw
    class S0_1,S0_2,S0_3 stage0
    class S1_1,S1_2,S1_3,S1_4 stage1
    class S2_A,S2_B,S2_C stage2
    class S3_1,S3_2,S3_3 stage3
    class S4_1,S4_2,S4_3,S4_OUT stage4
    class S0_4,S1_OUT,S2_OUT,S3_OUT data
